<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>JavaScript 工作原理: 引擎, 运行时和调用栈概述
| 天心阁</title><link href=/favicon.ico rel="shortcut icon" type=image/x-icon><meta name=author content="苏夏天心"><meta name=description content="天地人心"><meta name=generator content="Hugo 0.95.0"><link rel=canonical href=https://barryyan.github.io/program/engin-runtime-call-stack/><meta property="og:title" content="JavaScript 工作原理: 引擎, 运行时和调用栈概述"><meta property="og:description" content="概述 几乎每个人都听说过 V8 引擎这个概念, 大多数人都知道 JavaScript 是单线程的或者它使用的是回调队列. 在本文中, 我们将详细介绍这些概念, 并解释 JavaScript 实际上是如"><meta property="og:type" content="article"><meta property="og:url" content="https://barryyan.github.io/program/engin-runtime-call-stack/"><meta property="article:section" content="program"><meta property="article:published_time" content="2020-03-28T23:05:52+08:00"><meta property="article:modified_time" content="2020-03-29T00:59:54+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="JavaScript 工作原理: 引擎, 运行时和调用栈概述"><meta name=twitter:description content="概述 几乎每个人都听说过 V8 引擎这个概念, 大多数人都知道 JavaScript 是单线程的或者它使用的是回调队列. 在本文中, 我们将详细介绍这些概念, 并解释 JavaScript 实际上是如"><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/site.css><style>a{color:#00bfff!important}</style><style>.inverted a{color:#87cefa!important}</style></head><body style=background-image:url(/me/bg.jpeg)><div class=flip-container><div class=flipper><section class=front><nav class="ui secondary inverted menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick='window.location.href="https://barryyan.github.io"'></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div></nav><div class="ui centered relaxed grid dream-grid"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single"><section class="ui top attached segment" id=dream-save-post-as-img><header style=margin-top:0!important><h2 class="ui header">JavaScript 工作原理: 引擎, 运行时和调用栈概述<div class="sub header">@ 苏夏天心 · Saturday, Mar 28, 2020 · 3 分钟阅读 · 更新于 3月 29, 2020</div></h2></header><article style=margin-top:2rem><h2 id=概述>概述</h2><p>几乎每个人都听说过 V8 引擎这个概念, 大多数人都知道 JavaScript 是单线程的或者它使用的是回调队列.</p><p>在本文中, 我们将详细介绍这些概念, 并解释 JavaScript 实际上是如何运行的. 通过理解这些详细信息, 你能够利用这些 API 编写更好地非阻塞的应用程序.</p><p>如果你对 JavaScript 还比较陌生, 本文将帮助你理解为什么 JavaScript 与其他语言比如此"怪异".</p><p>如果你是一名经验丰富的 JavaScript 开发人员, 希望它能为你每天在实际工作中使用 JavaScript 运行时工作提供新的见解.</p><h2 id=javascript-引擎>JavaScript 引擎</h2><p>JavaScript 引擎最流行的是谷歌的 V8 引擎. 例如, Chrome 和 Node.js 使用的就是 V8 引擎. 下面是一个非常简单的视图:</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*OnH_DlbNAPvB9KLxUCyMsA.png alt></p><p>引擎由两个主要部分组成:</p><ol><li>内存堆: 这是分配内存发生的地方</li><li>调用栈: 这是代码执行是堆栈帧所在的位置</li></ol><h2 id=运行时runtime>运行时(Runtime)</h2><p>浏览器中有几乎所有开发人员都是用过的 API (如<code>setTimeout</code>). 然而, 这些 API 不是引擎提供的.</p><p>那么, 他们来自哪里呢?</p><p>事实证明, 真是的情况要复杂一些.</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*4lHHyfEhVB0LnQ3HlhSs8g.png alt></p><p>所以, 我们不但有引擎, 还有其它更多的东西: 那些由浏览器提供的 API, 比如 <code>DOM</code>, <code>AJAX</code> 以及 <code>setTimeout</code> 等等.</p><p>然后, 还有我们熟知的事件循环和回调队列.</p><h2 id=调用栈>调用栈</h2><p>JavaScript 是单线程语言, 意味着它只有一个调用栈, 因此, 它一次只能做一件事情.</p><p><strong>调用栈是一种数据结构, 它基本上记录了我们在程序中的位置.</strong> 如果我们进入了一个函数, 那么我们会把它放在堆栈顶部. 如果我们从函数返回, 就会从堆栈顶部弹出. 这就是堆栈所做所有的事情.</p><p>让我看看下面的例子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>multiply</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>y</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>y</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>printSquare</span>(<span style=color:#a6e22e>x</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>s</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>multiply</span>(<span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>x</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>s</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>printSquare</span>(<span style=color:#ae81ff>5</span>);
</span></span></code></pre></div><p>当引擎开始执行这段代码时, 调用栈是空的, 接下来会发生如下步骤:</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*Yp1KOt_UJ47HChmS9y7KXw.png alt></p><p>调用栈中的每一项叫做堆栈帧.</p><p>这种构造被用来精确追踪抛出的异常&mdash;-它基本上就是发生异常时调用栈的状态. 请看下面的代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>foo</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;SessionStack will help you resolve crashes :)&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>bar</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>foo</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bar</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>start</span>();
</span></span></code></pre></div><p>如果这个是在 Chrome 中执行的(假设代码位于 foo.js 文件中), 将生成以下追踪栈:</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*T-W_ihvl-9rG4dn18kP3Qw.png alt></p><p><strong>堆栈溢出</strong>, 达到最大调用堆栈时会发生这种情况. 它很容易发生, 特别是在使用递归而没有全面测试的情况下. 看看下面的示例代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>foo</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>foo</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>foo</span>();
</span></span></code></pre></div><p>当引擎开始执行这段代码时, 它从调用函数 <code>foo</code> 开始. 然而这个函数是递归的, 并且没有任何终止条件. 因此, 在每次执行的过程中相同的函数每次都被添加到调用栈中. 结果如下:</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*AycFMDy9tlDmNoc5LXd9-g.png alt></p><p>所以, 当调用栈红的函数数量超出了堆栈的大小时, 浏览器就会抛出错误, 像下面这样:</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*e0nEd59RPKz9coyY8FX-uw.png alt></p><p>在单线程上运行代码非常容易, 你不必处理多线程环境出现的复杂场景, 比如死锁.</p><p>但是在一个线程上运行的资源是有限的, 因为 JavaScript 只有一个调用栈, 所以当事情变慢的时候会发生什么呢?</p><h2 id=并发--事件循环>并发 & 事件循环</h2><p>如果调用堆栈中的函数调用需要大量的时间才能处理, 会发生什么呢? 例如, 你需要在浏览器中使用 JavaScript 做一些图像转换的操作.</p><p>你可能会问&mdash;-这有什么问题呢? 它的问题在于, 调用栈中有函数待执行, 但是实际上它却无法执行任何操作, 因为它被阻塞了. 这意味着浏览器不能去渲染页面, 也不能运行其它代码, 它卡住了. 它使你的应用的 UI 变的不再流畅.</p><p>还不仅仅是这个问题. 一旦浏览器开始处理调用栈中的大量任务, 它可能会在很长一段时间内停止响应. 大多数浏览器都会提示错误, 询问是否要终止网页.</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*WlMXK3rs_scqKTRV41au7g.jpeg alt></p><p>这不是最好的用户体验, 是吧?</p><p>那么, 我们如何去执行大量的代码而不阻塞 UI 并使浏览器无法响应呢? 解决方案就是异步回调.</p><p>请听下回分解.</p><blockquote><p>原文: <a href=https://blog.sessionstack.com/how-does-javascript-actually-work-part-1-b0bacc073cf>How JavaScript works: an overview of the engine, the runtime, and the call stack</a><br>作者: <a href=https://blog.sessionstack.com/@zlatkov>Alexander Zlatkov</a></p></blockquote></article></section><footer class="ui attached segment dream-tags"><a class="ui label" href=/tags/nodejs title=Nodejs>Nodejs</a>
<a class="ui label" href=/tags/v8 title=V8>V8</a>
<a class="ui label" href=/tags/javascript title=JavaScript>JavaScript</a><div class="ui label" style=float:right;cursor:pointer onclick=savePostAsImg()><i class="save icon"></i>保存为图片</div></footer><div class=github-comments><script src=https://utteranc.es/client.js repo=BarryYan/barryyan.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div><div class="sixteen wide mobile sixteen wide tablet four wide computer column"><article class=dream-header><section class="ui top attached center aligned segment"><div class="ui small circular image"><img src=/me/avatar.jpg></div><h1 class="ui medium header">苏夏天心<div class="sub header" style=margin-top:.5rem>你是什么样的人, 取决于你所做的决定!</div></h1><div class="ui horizontal list"><a class=item href=/tags><i class="tags icon" title=所有标签></i></a>
<a class=item href=/categories><i class="th list icon" title=所有分类></i></a></div></section><section class="ui attached center aligned segment dream-tags"><a class="ui label" href=/tags/education title=education>education</a>
<a class="ui label" href=/tags/image title=image>image</a>
<a class="ui label" href=/tags/javascript title=javascript>javascript</a>
<a class="ui label" href=/tags/map title=map>map</a>
<a class="ui label" href=/tags/music title=music>music</a>
<a class="ui label" href=/tags/nodejs title=nodejs>nodejs</a>
<a class="ui label" href=/tags/novel title=novel>novel</a>
<a class="ui label" href=/tags/v8 title=v8>v8</a>
<a class="ui label" href=/tags/video title=video>video</a>
<a class="ui label" href=/tags/%E6%AD%8C%E8%AF%8D title=歌词>歌词</a></section><section class="ui attached segment dream-categories"><div class="ui accordion"><div class=title><i class="dropdown icon"></i>
<a href=/categories/education class=item>education</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/others/jian-lai/ class=item>剑来</a></div></div><div class=item><div class=content><a href=/others/knowledge-map/ class=item>Knowledge Map</a></div></div></div></div><div class=title><i class="dropdown icon"></i>
<a href=/categories/javascript class=item>javascript</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/program/parse-video-metadata/ class=item>解析视频的元数据</a></div></div><div class=item><div class=content><a href=/program/javascript-the-new-keyword/ class=item>让我们揭开 JavaScript 关键字 new 的神秘面纱</a></div></div><div class=item><div class=content><a href=/program/engin-runtime-call-stack/ class=item>JavaScript 工作原理: 引擎, 运行时和调用栈概述</a></div></div><div class=item><div class=content><a href=/program/inside-the-v8-engin/ class=item>JavaScript 工作原理: V8引擎内部+关于如何编写及优化代码的5条建议</a></div></div></div></div><div class=title><i class="dropdown icon"></i>
<a href=/categories/music class=item>music</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/songs/light-dancer/ class=item>轻舞者</a></div></div><div class=item><div class=content><a href=/songs/is-passions-fault/ class=item>是热情惹的错</a></div></div></div></div></div></section><section class="ui attached segment header-socials"><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:barry.yanshg@gmail.com><i class="mail icon" title=Email></i></a></div><div class=item><a href=https://github.com/barryyan target=_blank><i class="github icon" title=GitHub></i></a></div></nav></section><section class="ui bottom attached center aligned segment"><p>© 2019 - 2022 天心阁</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with theme <a href=https://github.com/barryyan/hugo-theme-dream target=_blank>Dream</a>.</p></section></article></div></div></section><section class=back><nav class="ui secondary inverted menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick='window.location.href="https://barryyan.github.io"'></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div></nav><div class="ui centered relaxed grid dream-grid dream-back"><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">开源项目</h3></div><div class="ui attached segment markdown-body"><ul><li><p><a href=https://github.com/BarryYan/daily-warm>daily-warm</a> Send an email to someone you care about everyday, include weather, poem, an ONE word</p></li><li><p><a href=https://github.com/BarryYan/pixi-game>pixi-game</a> A library makes Pixi.js using easily, like phase.js</p></li><li><p><a href=https://github.com/BarryYan/parcel-plugin-css-url-loader>parcel-plugin-css-url-loader</a> A plugin for parcel to convert css/less/scss images url into base64.</p></li><li><p><a href=https://github.com/BarryYan/pre-commit>pre-commit</a> Git hook Check git merger conflict by default</p></li></ul></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">关于我</h3></div><div class="ui attached segment markdown-body"><h3 id=苏夏天心><strong>苏夏天心</strong></h3><p><code>UI Developer</code> <a href=https://thoughtworks.com>@ThoughtWorks</a></p><p><code>看书</code> - <code>听歌</code> - <code>美食</code> - <code>追剧</code> - <code>英语</code> - <code>Coding</code></p><p>技术栈</p><ul><li>JavaScript & Typescript</li><li>React.js & Vue.js & Angular</li><li>Go</li></ul></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">社交链接</h3></div><div class="ui attached segment"><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="large rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:barry.yanshg@gmail.com><i class="large mail icon" title=Email></i></a></div><div class=item><a href=https://github.com/barryyan target=_blank><i class="large github icon" title=GitHub></i></a></div></nav></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"></section></div></section></div></div><script src=/js/jquery.min.js></script>
<script src=/js/semantic.min.js></script>
<script src=/js/imagesloaded.pkgd.min.js></script>
<script src=/js/masonry.pkgd.min.js></script>
<script src=/js/nav.js></script>
<script src=/js/header.js></script>
<script src=/js/main.js></script>
<script src=/js/theme.js></script>
<script src=/js/html2canvas.min.js></script></body></html>