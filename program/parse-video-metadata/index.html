<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>解析视频的元数据
| 天心阁</title><link href=/favicon.ico rel="shortcut icon" type=image/x-icon><meta name=author content="苏夏天心"><meta name=description content="天地人心"><meta name=generator content="Hugo 0.80.0"><link rel=canonical href=https://barryyan.github.io/program/parse-video-metadata/><meta property="og:title" content="解析视频的元数据"><meta property="og:description" content="视频的元数据 ISO/IEC 14496-12:2005(E) - MP4 ISO/IEC 14496-1 Media Format - MP4 参考 Mp4 或称 MPEG-4 Part 14，是一种多媒体容器格式，扩展名为 .mp4. Mp4 文件由一系列的 box 构成, 每个 box 包含 box 头部和 box 体. box 体可以"><meta property="og:type" content="article"><meta property="og:url" content="https://barryyan.github.io/program/parse-video-metadata/"><meta property="article:published_time" content="2021-01-01T23:02:54+08:00"><meta property="article:modified_time" content="2021-01-01T23:02:54+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="解析视频的元数据"><meta name=twitter:description content="视频的元数据 ISO/IEC 14496-12:2005(E) - MP4 ISO/IEC 14496-1 Media Format - MP4 参考 Mp4 或称 MPEG-4 Part 14，是一种多媒体容器格式，扩展名为 .mp4. Mp4 文件由一系列的 box 构成, 每个 box 包含 box 头部和 box 体. box 体可以"><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/site.css><style>a{color:#00bfff!important}</style><style>.inverted a{color:#87cefa!important}</style></head><body style=background-image:url(/me/bg.jpeg)><div class=flip-container><div class=flipper><section class=front><nav class="ui secondary inverted menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick="window.location.href='https:\/\/barryyan.github.io'"></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div></nav><div class="ui centered relaxed grid dream-grid"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single"><section class="ui top attached segment" id=dream-save-post-as-img><header style=margin-top:0!important><h2 class="ui header">解析视频的元数据<div class="sub header">@ 苏夏天心 · Friday, Jan 1, 2021 · 2 分钟阅读 · 更新于 Jan 1, 2021</div></h2></header><article style=margin-top:2rem><p><video controls autoplay src=/media/hanzhong.mp4></video></p><h3 id=视频的元数据>视频的元数据</h3><blockquote><p><a href=https://web.archive.org/web/20180219054429/http://l.web.umkc.edu/lizhu/teaching/2016sp.video-communication/ref/mp4.pdf>ISO/IEC 14496-12:2005(E) - MP4</a><br><a href=http://xhelmboyx.tripod.com/formats/mp4-layout.txt>ISO/IEC 14496-1 Media Format - MP4</a>
<a href=https://www.jianshu.com/p/529c3729f357>参考</a></p></blockquote><p>Mp4 或称 MPEG-4 Part 14，是一种多媒体容器格式，扩展名为 <code>.mp4</code>.</p><p>Mp4 文件由一系列的 box 构成, 每个 box 包含 box 头部和 box 体. box 体可以包含普通的数据, 也可以包含其他的 box, 如果 box 中包含了另一个 box, 这种box 称为 container box.</p><p>如下图:<br><img width=400 src=/img/media-format.png></p><p>了解这个是因为工作中上传视频, 需要拿到视频的播放时长, 刚开始使用 <code>FileReader</code> 读取 <code>input</code> 的文件, 放到 <code>video</code> 的 <code>src</code> 去 <code>preload="metadata"</code>, 然后通过 <code>video element</code> 拿到 <code>duration</code>, 小视频没问题, 但是当上传的视频比较大的时候, <code>FileReader</code> 二次读取并加载到内存, 导致内存爆掉了, 于是决定去解析视频的元数据, 拿到 <code>duration</code>.</p><p>视频的元数据编码在上图中的 <code>mvhd</code> box 内, 编码规则如下:</p><pre><code>   * 8+ bytes movie (presentation) header box
       = long unsigned offset + long ASCII text string 'mvhd'
     -&gt; 1 byte version = 8-bit unsigned value
       - if version is 1 then date and duration values are 8 bytes in length
     -&gt; 3 bytes flags =  24-bit hex flags (current = 0)

     -&gt; 4 bytes created mac UTC date
         = long unsigned value in seconds since beginning 1904 to 2040
     -&gt; 4 bytes modified mac UTC date
         = long unsigned value in seconds since beginning 1904 to 2040
     OR
     -&gt; 8 bytes created mac UTC date
         = 64-bit unsigned value in seconds since beginning 1904
     -&gt; 8 bytes modified mac UTC date
         = 64-bit unsigned value in seconds since beginning 1904

     -&gt; 4 bytes time scale = long unsigned time unit per second (default = 600)

     -&gt; 4 bytes duration = long unsigned time length (in time units)
     OR
     -&gt; 8 bytes duration = 64-bit unsigned time length (in time units)

     -&gt; 4 bytes decimal user playback speed = long fixed point rate (normal = 1.0)
     -&gt; 2 bytes decimal user volume = short fixed point level
         (mute = 0.0 ; normal = 1.0 ; QUICKTIME MAX = 3.0)
     ...

    // 语法
    class MovieHeaderBox extends FullBox(‘mvhd’, version, 0) {
      if (version==1) {
      unsigned int(64) creation_time;
      unsigned int(64) modification_time;
      unsigned int(32) timescale;
      unsigned int(64) duration;
      } else { // version==0
      unsigned int(32) creation_time;
      unsigned int(32) modification_time;
      unsigned int(32) timescale;
      unsigned int(32) duration;
      }
      template int(32) rate = 0x00010000; // typically 1.0
      template int(16) volume = 0x0100; // typically, full volume
      const bit(16) reserved = 0;
      const unsigned int(32)[2] reserved = 0;
      template int(32)[9] matrix =
      { 0x00010000,0,0,0,0x00010000,0,0,0,0x40000000 };
      // Unity matrix
      bit(32)[6] pre_defined = 0;
      unsigned int(32) next_track_ID;
  }
</code></pre><p>所以, 有了如下代码:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>input</span> <span style=color:#a6e22e>id</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;input&#34;</span> <span style=color:#a6e22e>type</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;file&#34;</span> /&gt;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>input</span> <span style=color:#f92672>=</span> document.<span style=color:#a6e22e>getElementById</span>(<span style=color:#e6db74>&#39;input&#39;</span>)
<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>onchange</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>e</span>) =&gt; {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>target</span>.<span style=color:#a6e22e>files</span>[<span style=color:#ae81ff>0</span>]
  <span style=color:#a6e22e>file</span>
    .<span style=color:#a6e22e>slice</span>()
    .<span style=color:#a6e22e>arrayBuffer</span>()
    .<span style=color:#a6e22e>then</span>((<span style=color:#a6e22e>ab</span>) =&gt; {
      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getVideoDuration</span>(<span style=color:#a6e22e>ab</span>)
    })
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getVideoDuration</span>(<span style=color:#a6e22e>arrayBuffer</span>) {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>dv</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>arrayBuffer</span>)
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>MVHD</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x6d766864</span>
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>uint32length</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>maxOffset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>byteLength</span>
  
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>timeScale</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
  <span style=color:#66d9ef>while</span> (<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>uint32length</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>maxOffset</span>) {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span>)
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>val</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>MVHD</span>) {
      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint8</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>)
      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>version</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>modifyTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)
        <span style=color:#a6e22e>timeScale</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)
        <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)
      } <span style=color:#66d9ef>else</span> {
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createTime</span> <span style=color:#f92672>=</span> Number(
          <span style=color:#e6db74>`0x</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)<span style=color:#e6db74>}${</span><span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
        )
        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>modifyTime</span> <span style=color:#f92672>=</span> Number(
          <span style=color:#e6db74>`0x</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)<span style=color:#e6db74>}${</span><span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
        )
        <span style=color:#a6e22e>timeScale</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>6</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)
        <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dv</span>.<span style=color:#a6e22e>getUint32</span>(<span style=color:#a6e22e>offset</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>uint32length</span>)
      }
      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>canPlayTime</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>timeScale</span>
      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>canPlayTime</span>
    }
    <span style=color:#a6e22e>offset</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>2</span>
  }
  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
}
</code></pre></div></article></section><footer class="ui attached segment dream-tags"><a class="ui label" href=/tags/javascript title=JavaScript>JavaScript</a>
<a class="ui label" href=/tags/image title=image>image</a>
<a class="ui label" href=/tags/video title=video>video</a><div class="ui label" style=float:right;cursor:pointer onclick=savePostAsImg()><i class="save icon"></i>保存为图片</div></footer><div class=github-comments><script src=https://utteranc.es/client.js repo=BarryYan/barryyan.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div><div class="sixteen wide mobile sixteen wide tablet four wide computer column"><article class=dream-header><section class="ui top attached center aligned segment"><div class="ui small circular image"><img src=/me/avatar.jpg></div><h1 class="ui medium header">苏夏天心<div class="sub header" style=margin-top:.5rem>你是什么样的人, 取决于你所做的决定!</div></h1><div class="ui horizontal list"><a class=item href=/tags><i class="tags icon" title=所有标签></i></a><a class=item href=/categories><i class="th list icon" title=所有分类></i></a></div></section><section class="ui attached center aligned segment dream-tags"><a class="ui label" href=/tags/education title=education>education</a>
<a class="ui label" href=/tags/image title=image>image</a>
<a class="ui label" href=/tags/javascript title=javascript>javascript</a>
<a class="ui label" href=/tags/map title=map>map</a>
<a class="ui label" href=/tags/music title=music>music</a>
<a class="ui label" href=/tags/nodejs title=nodejs>nodejs</a>
<a class="ui label" href=/tags/novel title=novel>novel</a>
<a class="ui label" href=/tags/v8 title=v8>v8</a>
<a class="ui label" href=/tags/video title=video>video</a>
<a class="ui label" href=/tags/%E6%AD%8C%E8%AF%8D title=歌词>歌词</a></section><section class="ui attached segment dream-categories"><div class="ui accordion"><div class=title><i class="dropdown icon"></i><a href=/categories/education class=item>education</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/others/jian-lai/ class=item>剑来</a></div></div><div class=item><div class=content><a href=/others/knowledge-map/ class=item>Knowledge Map</a></div></div></div></div><div class=title><i class="dropdown icon"></i><a href=/categories/javascript class=item>javascript</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/program/parse-video-metadata/ class=item>解析视频的元数据</a></div></div><div class=item><div class=content><a href=/program/javascript-the-new-keyword/ class=item>让我们揭开 JavaScript 关键字 new 的神秘面纱</a></div></div><div class=item><div class=content><a href=/program/engin-runtime-call-stack/ class=item>JavaScript 工作原理: 引擎, 运行时和调用栈概述</a></div></div><div class=item><div class=content><a href=/program/inside-the-v8-engin/ class=item>JavaScript 工作原理: V8引擎内部+关于如何编写及优化代码的5条建议</a></div></div></div></div><div class=title><i class="dropdown icon"></i><a href=/categories/music class=item>music</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/songs/light-dancer/ class=item>轻舞者</a></div></div><div class=item><div class=content><a href=/songs/is-passions-fault/ class=item>是热情惹的错</a></div></div></div></div></div></section><section class="ui attached segment header-socials"><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:barry.yanshg@gmail.com><i class="mail icon" title=Email></i></a></div><div class=item><a href=https://github.com/barryyan target=_blank><i class="github icon" title=GitHub></i></a></div></nav></section><section class="ui bottom attached center aligned segment"><p>© 2019 - 2021 天心阁</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with theme <a href=https://github.com/barryyan/hugo-theme-dream target=_blank>Dream</a>.</p></section></article></div></div></section><section class=back><nav class="ui secondary inverted menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick="window.location.href='https:\/\/barryyan.github.io'"></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div></nav><div class="ui centered relaxed grid dream-grid dream-back"><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">开源项目</h3></div><div class="ui attached segment markdown-body"><ul><li><p><a href=https://github.com/BarryYan/daily-warm>daily-warm</a> Send an email to someone you care about everyday, include weather, poem, an ONE word</p></li><li><p><a href=https://github.com/BarryYan/pixi-game>pixi-game</a> A library makes Pixi.js using easily, like phase.js</p></li><li><p><a href=https://github.com/BarryYan/parcel-plugin-css-url-loader>parcel-plugin-css-url-loader</a> A plugin for parcel to convert css/less/scss images url into base64.</p></li><li><p><a href=https://github.com/BarryYan/pre-commit>pre-commit</a> Git hook Check git merger conflict by default</p></li></ul></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">关于我</h3></div><div class="ui attached segment markdown-body"><h3 id=苏夏天心><strong>苏夏天心</strong></h3><p><code>UI Developer</code> <a href=https://thoughtworks.com>@ThoughtWorks</a></p><p><code>看书</code> - <code>听歌</code> - <code>美食</code> - <code>追剧</code> - <code>英语</code> - <code>Coding</code></p><p>技术栈</p><ul><li>JavaScript & Typescript</li><li>React.js & Vue.js & Angular</li><li>Go</li></ul></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">社交链接</h3></div><div class="ui attached segment"><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=/index.xml><i class="large rss square icon" title=RSS></i></a></div><div class=item><a href=mailto:barry.yanshg@gmail.com><i class="large mail icon" title=Email></i></a></div><div class=item><a href=https://github.com/barryyan target=_blank><i class="large github icon" title=GitHub></i></a></div></nav></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"></section></div></section></div></div><script src=/js/jquery.min.js></script><script src=/js/semantic.min.js></script><script src=/js/imagesloaded.pkgd.min.js></script><script src=/js/masonry.pkgd.min.js></script><script src=/js/nav.js></script><script src=/js/header.js></script><script src=/js/main.js></script><script src=/js/theme.js></script><script src=/js/html2canvas.min.js></script></body></html>